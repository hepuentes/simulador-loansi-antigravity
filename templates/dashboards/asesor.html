{% extends 'dashboards/_base_dashboard.html' %}

{% block title %}Mi Panel - Asesor{% endblock %}

{% block dashboard_content %}
<div class="row g-3 mb-4">
    <!-- Stat: Evaluaciones hoy -->
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-clipboard-check"></i>
            </div>
            <div class="stat-value">{{ stats.evaluaciones_hoy or 0 }}</div>
            <div class="stat-label">Evaluaciones hoy</div>
        </div>
    </div>

    <!-- Stat: Simulaciones hoy -->
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-success bg-opacity-10 text-success">
                <i class="bi bi-calculator"></i>
            </div>
            <div class="stat-value">{{ stats.simulaciones_hoy or 0 }}</div>
            <div class="stat-label">Simulaciones hoy</div>
        </div>
    </div>

    <!-- Stat: Casos pendientes comité -->
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-value">{{ stats.casos_pendientes_comite or 0 }}</div>
            <div class="stat-label">En comité</div>
        </div>
    </div>

    <!-- Stat: Respuestas nuevas -->
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                <i class="bi bi-bell-fill"></i>
            </div>
            <div class="stat-value">{{ stats.casos_nuevos or 0 }}</div>
            <div class="stat-label">Respuestas nuevas</div>
            {% if stats.casos_nuevos and stats.casos_nuevos > 0 %}
            <div class="stat-change text-danger">
                <i class="bi bi-exclamation-circle"></i> Pendientes de revisar
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Columna izquierda: Acciones rápidas -->
    <div class="col-lg-4">
        <div class="quick-actions">
            <h5><i class="bi bi-lightning-charge me-2"></i>Acciones Rápidas</h5>

            {% if tiene_permiso('sim_usar') %}
            <a href="/simulador" class="quick-action-btn">
                <i class="bi bi-calculator text-primary"></i>
                <span>Nueva Simulación</span>
            </a>
            {% endif %}

            {% if tiene_permiso('cap_usar') %}
            <a href="/capacidad_pago" class="quick-action-btn">
                <i class="bi bi-cash-stack text-success"></i>
                <span>Capacidad de Pago</span>
            </a>
            {% endif %}

            {% if tiene_permiso('sco_ejecutar') %}
            <a href="/scoring" class="quick-action-btn">
                <i class="bi bi-graph-up text-info"></i>
                <span>Evaluar Scoring</span>
            </a>
            {% endif %}

            {% if tiene_alguno_de(['com_enviar', 'com_ver_propios']) %}
            <a href="/asesor/mis-casos-comite" class="quick-action-btn">
                <i class="bi bi-folder-check text-warning"></i>
                <span>Mis Casos Comité</span>
                {% if stats.casos_nuevos and stats.casos_nuevos > 0 %}
                <span class="badge bg-danger ms-auto">{{ stats.casos_nuevos }}</span>
                {% endif %}
            </a>
            {% endif %}
        </div>

        <!-- Resumen de la semana -->
        <div class="data-panel">
            <h5><i class="bi bi-calendar-week"></i> Esta Semana</h5>
            <ul class="data-list">
                <li>
                    <span class="item-label">Evaluaciones</span>
                    <span class="item-value">{{ stats.evaluaciones_semana or 0 }}</span>
                </li>
                <li>
                    <span class="item-label">Simulaciones</span>
                    <span class="item-value">{{ stats.simulaciones_semana or 0 }}</span>
                </li>
                <li>
                    <span class="item-label">Aprobados</span>
                    <span class="item-value text-success">{{ stats.casos_aprobados or 0 }}</span>
                </li>
                <li>
                    <span class="item-label">Rechazados</span>
                    <span class="item-value text-danger">{{ stats.casos_rechazados or 0 }}</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- Columna derecha: Resumen total -->
    <div class="col-lg-8">
        <div class="data-panel">
            <h5><i class="bi bi-bar-chart"></i> Mi Resumen</h5>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">
                            {{ stats.evaluaciones_total or 0 }}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Total evaluaciones
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">
                            {{ stats.simulaciones_total or 0 }}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Total simulaciones
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                        {% set total_comite = (stats.casos_aprobados or 0) + (stats.casos_rechazados or 0) %}
                        {% if total_comite > 0 %}
                            {% set tasa = ((stats.casos_aprobados or 0) / total_comite * 100)|round(1) %}
                        {% else %}
                            {% set tasa = 0 %}
                        {% endif %}
                        <div style="font-size: 2rem; font-weight: 700; color: {% if tasa >= 50 %}#198754{% else %}#dc3545{% endif %};">
                            {{ tasa }}%
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Tasa aprobación
                        </div>
                    </div>
                </div>
            </div>

            {% if stats.ultima_actividad %}
            <div class="mt-3 text-center" style="font-size: 0.8rem; color: var(--text-muted);">
                <i class="bi bi-clock"></i> Última actividad: {{ stats.ultima_actividad[:16] if stats.ultima_actividad else 'N/A' }}
            </div>
            {% endif %}
        </div>

        <!-- Acceso rápido a historial -->
        <div class="row g-3">
            {% if tiene_alguno_de(['sim_hist_propio', 'sim_hist_equipo', 'sim_hist_todos']) %}
            <div class="col-md-6">
                <a href="/historial_simulaciones" class="data-panel d-block text-decoration-none" style="text-align: center;">
                    <i class="bi bi-clock-history" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <h6 class="mt-2 mb-0">Historial Simulaciones</h6>
                    <small class="text-muted">Ver mis simulaciones</small>
                </a>
            </div>
            {% endif %}

            {% if tiene_alguno_de(['sco_hist_propio', 'sco_hist_equipo', 'sco_hist_todos']) %}
            <div class="col-md-6">
                <a href="/admin/historial-evaluaciones" class="data-panel d-block text-decoration-none" style="text-align: center;">
                    <i class="bi bi-file-earmark-text" style="font-size: 2rem; color: var(--success-color);"></i>
                    <h6 class="mt-2 mb-0">Historial Evaluaciones</h6>
                    <small class="text-muted">Ver mis evaluaciones</small>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
