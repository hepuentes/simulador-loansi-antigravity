<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Evaluaci√≥n de Capacidad de Pago - Loansi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/components.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f1f3f5;
            border-bottom: 1px solid rgba(0,0,0,0.125);
            font-weight: bold;
        }
        .result-box {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-header {
            background-color: #0d6efd;
            color: white;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            margin: -20px -20px 20px -20px;
        }
        .percentage-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 8px 0;
            line-height: 1;
        }
        .badge-level {
            font-size: 16px;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
       /* Badge personalizado para Moderado */
        .badge-moderado {
            background-color: #FAFA8F !important;
            color: #333 !important;
        }
        /* Badge personalizado para Alto Riesgo */
        .badge-alto-riesgo {
            background-color: #fd7e14 !important;
            color: #fff !important;
        }

        /* Estilos unificados para TODOS los badges del sistema */
        .badge.bg-success,
        .badge-success {
            background-color: #28a745 !important;
            color: #fff !important;
        }

        .badge.bg-info,
        .badge-info {
            background-color: #17a2b8 !important;
            color: #fff !important;
        }

        .badge.bg-warning,
        .badge-warning,
        .badge-moderado {
            background-color: #FAFA8F !important;
            color: #333 !important;
        }

        .badge-alto-riesgo {
            background-color: #fd7e14 !important;
            color: #fff !important;
        }

        .badge.bg-danger,
        .badge-danger {
            background-color: #dc3545 !important;
            color: #fff !important;
        }
        .amount-box {
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            color: white;
        }
        .amount-box h5 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        .amount-box .amount {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .amount-box small {
            font-size: 12px;
            opacity: 1 !important;
            color: white !important;
            font-weight: 500 !important;
        }
        .max-amount {
            background-color: #0d6efd;
        }
        .recommended-amount {
            background-color: #198754;
        }
        .formula-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .metodologia-badge {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        .fuente-indicator {
            background-color: #e8f4fd;
            border-left: 4px solid #0d6efd;
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            margin: 5px 0;
        }
        .metodologia-detail {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 5px solid #0d6efd;
        }
        .metodologia-info-box {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            border-left: 5px solid #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metodologia-value {
            font-size: 1.15rem;
            font-weight: bold;
            color: #0d6efd;
            margin: 5px 0;
        }
        .metodologia-label {
            font-size: 1.05rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        .metodologia-source {
            font-size: 0.9rem;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }
/* ========================================
   SWITCH "USAR DATACR√âDITO" - CORRECCI√ìN DEFINITIVA
   ======================================== */

/* TEMA CLARO - Base del switch */
.form-check-input[type="checkbox"] {
    width: 3rem !important;
    height: 1.5rem !important;
    background-color: #e2e8f0 !important;
    border: 2px solid #cbd5e0 !important;
    background-image: none !important;
    position: relative !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
}

/* TEMA CLARO - C√≠rculo del switch (pseudo-elemento) */
.form-check-input[type="checkbox"]::before {
    content: '' !important;
    position: absolute !important;
    width: 1.1rem !important;
    height: 1.1rem !important;
    background-color: white !important;
    border-radius: 50% !important;
    top: 50% !important;
    left: 2px !important;
    transform: translateY(-50%) !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* TEMA CLARO - Switch activado */
.form-check-input[type="checkbox"]:checked {
    background-color: #667eea !important;
    border-color: #667eea !important;
}

/* TEMA CLARO - C√≠rculo cuando est√° activado */
.form-check-input[type="checkbox"]:checked::before {
    left: calc(100% - 1.1rem - 2px) !important;
    background-color: white !important;
}

/* TEMA CLARO - Estados hover y focus */
.form-check-input[type="checkbox"]:hover {
    background-color: #cbd5e0 !important;
    border-color: #a0aec0 !important;
}

.form-check-input[type="checkbox"]:checked:hover {
    background-color: #5a67d8 !important;
    border-color: #5a67d8 !important;
}

.form-check-input[type="checkbox"]:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
    outline: none !important;
}

/* ========================================
   TEMA OSCURO - FORZAR VISIBILIDAD TOTAL
   ======================================== */

/* TEMA OSCURO - Base del switch */
[data-theme="dark"] .form-check-input[type="checkbox"] {
    background-color: #374151 !important;
    border: 2px solid #4a5568 !important;
}

/* TEMA OSCURO - C√≠rculo SIEMPRE VISIBLE */
[data-theme="dark"] .form-check-input[type="checkbox"]::before {
    content: '' !important;
    background-color: #1f2937 !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5) !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 10 !important;
}

/* TEMA OSCURO - Switch activado */
[data-theme="dark"] .form-check-input[type="checkbox"]:checked {
    background-color: #7c8cfc !important;
    border-color: #7c8cfc !important;
}

/* TEMA OSCURO - C√≠rculo cuando est√° activado */
[data-theme="dark"] .form-check-input[type="checkbox"]:checked::before {
    background-color: white !important;
    box-shadow: 0 2px 8px rgba(124, 140, 252, 0.5) !important;
}

/* TEMA OSCURO - Estados hover */
[data-theme="dark"] .form-check-input[type="checkbox"]:hover {
    background-color: #4a5568 !important;
    border-color: #6b7280 !important;
}

[data-theme="dark"] .form-check-input[type="checkbox"]:checked:hover {
    background-color: #667eea !important;
    border-color: #667eea !important;
}

/* TEMA OSCURO - Focus */
[data-theme="dark"] .form-check-input[type="checkbox"]:focus {
    box-shadow: 0 0 0 0.25rem rgba(124, 140, 252, 0.4) !important;
    outline: none !important;
}

/* PREVENIR QUE BOOTSTRAP SOBRESCRIBA */
[data-theme="dark"] .form-check-input[type="checkbox"]:focus::before,
[data-theme="dark"] .form-check-input[type="checkbox"]:active::before,
[data-theme="dark"] .form-check-input[type="checkbox"]:hover::before {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Labels asociados */
[data-theme="dark"] .form-check-label {
    color: #f7fafc !important;
    font-weight: 500 !important;
}

[data-theme="dark"] .form-check .text-muted {
    color: #a0aec0 !important;
}

/* BADGE "METODOLOG√çA H√çBRIDA" - CONTRASTE CORRECTO */
[data-theme="dark"] .metodologia-badge {
    background: linear-gradient(135deg, #7c8cfc, #667eea) !important;
    color: white !important;
    border: 2px solid #667eea !important;
    box-shadow: 0 0 20px rgba(124, 140, 252, 0.4) !important;
}

/* CONTENEDOR METODOLOG√çA DETAIL - FONDO OSCURO */
[data-theme="dark"] .metodologia-detail {
    background: linear-gradient(135deg, #1f2937, #111827) !important;
    border-left: 5px solid #7c8cfc !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .metodologia-detail h6 {
    color: #f7fafc !important;
}

[data-theme="dark"] .metodologia-detail .row {
    color: #e2e8f0 !important;
}

/* FUENTE INDICATOR - CAJAS INFORMATIVAS */
[data-theme="dark"] .fuente-indicator {
    background-color: rgba(124, 140, 252, 0.1) !important;
    border-left: 4px solid #7c8cfc !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .fuente-indicator strong {
    color: #f7fafc !important;
}

[data-theme="dark"] .fuente-indicator small {
    color: #a0aec0 !important;
}

[data-theme="dark"] .fuente-indicator .text-success,
[data-theme="dark"] .fuente-indicator .text-info {
    color: #68d391 !important;
}

/* ALERT SUCCESS EN METODOLOG√çA */
[data-theme="dark"] .metodologia-detail .alert-success {
    background-color: rgba(104, 211, 145, 0.1) !important;
    border-left: 4px solid #68d391 !important;
    color: #68d391 !important;
}

[data-theme="dark"] .metodologia-detail .alert-success strong {
    color: #68d391 !important;
}

[data-theme="dark"] .metodologia-detail .alert-success small {
    color: #a0aec0 !important;
}

/* BADGE "OBLIGACIONES ESTIMADAS" - CONTRASTE CORRECTO */
[data-theme="dark"] .alert-secondary {
    background-color: #1f2937 !important;
    border: 2px solid #4a5568 !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .alert-secondary .text-muted,
[data-theme="dark"] .alert-secondary small {
    color: #a0aec0 !important;
}

[data-theme="dark"] .alert-secondary .fw-bold {
    color: #7c8cfc !important;
}

/* ALERT INFO - METODOLOG√çA APLICADA */
[data-theme="dark"] .alert-primary {
    background-color: rgba(124, 140, 252, 0.1) !important;
    border-left: 4px solid #7c8cfc !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .alert-primary h6 {
    color: #ffffff !important;
    font-weight: 600 !important;
}

[data-theme="dark"] .alert-primary p {
    color: #e2e8f0 !important;
}

/* METODOLOG√çA INFO BOX - CONTRASTE PERFECTO */
[data-theme="dark"] .metodologia-info-box {
    background: linear-gradient(135deg, #1f2937, #111827) !important;
    border-left: 5px solid #7c8cfc !important;
    border: 2px solid #4a5568 !important;
}

[data-theme="dark"] .metodologia-label {
    color: #f7fafc !important;
}

[data-theme="dark"] .metodologia-value {
    color: #7c8cfc !important;
}

[data-theme="dark"] .metodologia-source {
    color: #a0aec0 !important;
}

/* RESULT BOX - RESULTADO DEL AN√ÅLISIS */
[data-theme="dark"] .result-box {
    background-color: #16162e !important;
    border: 2px solid #4a5568 !important;
}

[data-theme="dark"] .result-header {
    background-color: #7c8cfc !important;
    color: white !important;
}

[data-theme="dark"] .result-box h6,
[data-theme="dark"] .result-box h5 {
    color: #f7fafc !important;
}

/* TABLAS EN RESULT BOX */
[data-theme="dark"] .result-box .table {
    background-color: #1f2937 !important;
}

[data-theme="dark"] .result-box .table td {
    color: #f7fafc !important;
    border-color: #4a5568 !important;
}

[data-theme="dark"] .result-box .table .table-primary {
    background-color: rgba(124, 140, 252, 0.2) !important;
}

[data-theme="dark"] .result-box .table .table-primary td {
    color: #7c8cfc !important;
    font-weight: 600;
}

/* AMOUNT BOXES - MONTOS M√ÅXIMO Y RECOMENDADO */
[data-theme="dark"] .amount-box {
    border: 2px solid rgba(255, 255, 255, 0.1) !important;
}

[data-theme="dark"] .amount-box h5 {
    color: white !important;
}

[data-theme="dark"] .amount-box .amount {
    color: white !important;
}

[data-theme="dark"] .amount-box small {
    color: rgba(255, 255, 255, 0.8) !important;
}

/* ALERT SECONDARY - ACLARACI√ìN IMPORTANTE */
[data-theme="dark"] .alert.alert-secondary.mb-4 {
    background-color: #1f2937 !important;
    border-left: 4px solid #f6ad55 !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .alert.alert-secondary h6 {
    color: #f7fafc !important;
}

[data-theme="dark"] .alert.alert-secondary p {
    color: #e2e8f0 !important;
}

[data-theme="dark"] .alert.alert-secondary strong {
    color: #f6ad55 !important;
}

/* CARD BG-LIGHT - RECOMENDACI√ìN FINTECH */
[data-theme="dark"] .card.bg-light.border-primary {
    background-color: #1f2937 !important;
    border: 2px solid #7c8cfc !important;
}

[data-theme="dark"] .card.bg-light.border-primary .card-body {
    color: #f7fafc !important;
}

[data-theme="dark"] .card.bg-light.border-primary h6 {
    color: #f7fafc !important;
}

[data-theme="dark"] .card.bg-light.border-primary p {
    color: #e2e8f0 !important;
}

[data-theme="dark"] .card.bg-light.border-primary ul li {
    color: #e2e8f0 !important;
}

/* ALERT INFO FINAL - RECOMENDACI√ìN ASESOR */
[data-theme="dark"] .alert.alert-info {
    background-color: rgba(99, 179, 237, 0.1) !important;
    border-left: 4px solid #63b3ed !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .alert.alert-info h6 {
    color: #f7fafc !important;
}

[data-theme="dark"] .alert.alert-info p {
    color: #e2e8f0 !important;
}

/* TABLA DE REFERENCIA - HEADERS */
[data-theme="dark"] .card .card-header h5 {
    color: white !important;
}
/* CARD-HEADER FONDO OSCURO */
[data-theme="dark"] .card-header {
    background-color: #1f2937 !important;
    border-bottom: 2px solid #4a5568 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .card-header h5 {
    color: #ffffff !important;
    font-weight: 600 !important;
}
[data-theme="dark"] .table thead {
    background: linear-gradient(135deg, #7c8cfc 0%, #667eea 100%) !important;
}

[data-theme="dark"] .table thead th {
    color: white !important;
}

/* FILAS DE TABLA CON COLORES (SUCCESS, INFO, WARNING, DANGER) */
[data-theme="dark"] .table tbody .table-success {
    background-color: rgba(104, 211, 145, 0.2) !important;
}

[data-theme="dark"] .table tbody .table-success td {
    color: #68d391 !important;
}

[data-theme="dark"] .table tbody .table-info {
    background-color: rgba(99, 179, 237, 0.2) !important;
}

[data-theme="dark"] .table tbody .table-info td {
    color: #63b3ed !important;
}

[data-theme="dark"] .table tbody .table-warning {
    background-color: rgba(246, 173, 85, 0.2) !important;
}

[data-theme="dark"] .table tbody .table-warning td {
    color: #f6ad55 !important;
}

[data-theme="dark"] .table tbody .table-danger {
    background-color: rgba(252, 129, 129, 0.2) !important;
}

[data-theme="dark"] .table tbody .table-danger td {
    color: #fc8181 !important;
}
/* Forzar texto blanco en badges de montos - AMBOS TEMAS */
.max-amount small,
.recommended-amount small {
    color: white !important;
    opacity: 1 !important;
}

[data-theme="dark"] .max-amount small,
[data-theme="dark"] .recommended-amount small {
    color: white !important;
    opacity: 1 !important;
}
/*  BARRA GR√ÅFICA DE ENDEUDAMIENTO - MARCADORES ARRIBA, INDICADOR ABAJO */

.debt-meter-container {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 25px 20px;
    margin-bottom: 20px;
}

.debt-meter-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
    text-align: center;
}

/* Contenedor de marcadores (arriba de la barra) */
.debt-meter-markers {
    position: relative;
    height: 35px;
    margin-bottom: 10px;
}

/* Marcadores individuales - ARRIBA con z-index para evitar solapamiento */
.debt-meter-marker {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
    text-align: center;
    z-index: 10;
}

/* Z-index descendente: los de la izquierda van arriba */
.debt-meter-marker:nth-child(1) { z-index: 14; } /* 25% */
.debt-meter-marker:nth-child(2) { z-index: 13; } /* 30% */
.debt-meter-marker:nth-child(3) { z-index: 12; } /* 35% */
.debt-meter-marker:nth-child(4) { z-index: 11; } /* 40% */

.debt-meter-marker-line {
    width: 2px;
    height: 25px;
    background: var(--text-secondary);
    margin: 0 auto 5px;
    opacity: 0.6;
}

.debt-meter-marker span {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
    background: var(--card-bg);
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Barra de colores */
.debt-meter-bar {
    position: relative;
    height: 45px;
    background: linear-gradient(to right,
        #28a745 0%,
        #28a745 25%,
        #17a2b8 25%,
        #17a2b8 30%,
        #FAFA8F 30%,
        #FAFA8F 35%,
        #fd7e14 35%,
        #fd7e14 40%,
        #dc3545 40%,
        #dc3545 100%
    );
    border-radius: 25px;
    margin-bottom: 15px;
    overflow: visible;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Contenedor del indicador (abajo de la barra) */
.debt-meter-indicator-wrapper {
    position: relative;
    height: 40px;
    margin-bottom: 15px;
}

/* Indicador de posici√≥n actual - ABAJO */
.debt-meter-indicator {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
    transition: left 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.debt-meter-indicator-arrow {
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 18px solid var(--text-primary);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    margin: 0 auto 4px;
}

.debt-meter-value {
    display: block;
    background: var(--text-primary);
    color: var(--card-bg);
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* Leyenda de colores */
.debt-meter-legend {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    margin-bottom: 25px;
    padding-top: 15px;
    padding-bottom: 15px;
    border-top: 1px solid var(--border-color);
}

.debt-meter-legend-item {
    display: flex;
    align-items: center;
    font-size: 11px;
    color: var(--text-secondary);
    gap: 5px;
}

.debt-meter-legend-color {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    flex-shrink: 0;
}

/* BOT√ìN INTEGRACI√ìN SCORING */

.btn-scoring-integration {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-scoring-integration:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn-scoring-integration i {
    margin-right: 8px;
}

/* RESPONSIVE: Ajustes para m√≥vil */
@media (max-width: 768px) {
    .debt-meter-container {
        padding: 20px 15px;
    }

    .debt-meter-title {
        font-size: 14px;
        margin-bottom: 15px;
    }

    .debt-meter-markers {
        height: 30px;
    }

    .debt-meter-marker-line {
        height: 20px;
    }

    .debt-meter-marker span {
        font-size: 10px;
        padding: 1px 4px;
    }

    .debt-meter-bar {
        height: 35px;
        margin-bottom: 12px;
    }

    .debt-meter-indicator-wrapper {
        height: 35px;
    }

    .debt-meter-indicator-arrow {
        border-left-width: 10px;
        border-right-width: 10px;
        border-top-width: 16px;
    }

    .debt-meter-value {
        font-size: 12px;
        padding: 4px 8px;
    }

    .debt-meter-legend {
        flex-direction: column;
        gap: 6px;
    }

    .debt-meter-legend-item {
        font-size: 10px;
    }

    .debt-meter-legend-color {
        width: 14px;
        height: 14px;
    }
}
@media (max-width: 768px) {
    .debt-meter-container {
        padding: 20px 15px;
    }

    .debt-meter-title {
        font-size: 14px;
        margin-bottom: 15px;
    }

    .debt-meter-markers {
        height: 30px;
    }

    .debt-meter-marker-line {
        height: 20px;
    }

    .debt-meter-bar {
        height: 35px;
        margin-bottom: 12px;
    }

    .debt-meter-indicator-wrapper {
        height: 35px;
    }

    .debt-meter-indicator-arrow {
        border-left-width: 8px;
        border-right-width: 8px;
        border-top-width: 14px;
    }

    .debt-meter-value {
        font-size: 11px;
        padding: 3px 6px;
    }

    .debt-meter-legend {
        flex-direction: column;
        gap: 6px;
    }

    .debt-meter-legend-item {
        font-size: 11px;
    }

    .debt-meter-legend-color {
        width: 16px;
        height: 16px;
    }

    /* Mejorar espaciado en m√≥vil */
    .percentage-display {
        font-size: 36px;
        margin: 4px 0;
    }

    .badge-level {
        font-size: 13px;
        padding: 4px 12px;
    }

    /* Alinear contenido en m√≥vil */
    .row.mb-3 {
        margin-bottom: 1rem !important;
    }

    .col-md-4 {
        padding: 10px 15px;
    }
}

/* TEMA OSCURO: Ajustes adicionales */
[data-theme="dark"] .debt-meter-bar {
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

[data-theme="dark"] .debt-meter-marker-line {
    background: var(--text-secondary);
}

/* Badges en tema oscuro - mantener colores consistentes */
[data-theme="dark"] .badge-moderado {
    background-color: #FAFA8F !important;
    color: #000000 !important;
    font-weight: 700 !important;
}

[data-theme="dark"] .badge-alto-riesgo {
    background-color: #fd7e14 !important;
    color: #000000 !important;
    font-weight: 700 !important;
}

[data-theme="dark"] .badge.bg-success,
[data-theme="dark"] .badge-success {
    background-color: #28a745 !important;
    color: #000000 !important;
    font-weight: 700 !important;
}

[data-theme="dark"] .badge.bg-info,
[data-theme="dark"] .badge-info {
    background-color: #17a2b8 !important;
    color: #000000 !important;
    font-weight: 700 !important;
}

[data-theme="dark"] .badge.bg-danger,
[data-theme="dark"] .badge-danger {
    background-color: #dc3545 !important;
    color: #000000 !important;
    font-weight: 700 !important;
}

[data-theme="dark"] .debt-meter-value {
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    color: #000000 !important;
    font-weight: 700 !important;
}
    </style>

    <script>
        // ============================================
        // MEJORA: VARIABLES GLOBALES PARA PAR√ÅMETROS DIN√ÅMICOS
        // ============================================

        let parametrosCapacidad = {
            limite_conservador: 30,
            limite_maximo: 35,
            limite_absoluto: 40
        };

        let datosCapacidadActuales = {}; // Para guardar datos y transferir a scoring

        // ============================================
        // MEJORA: CARGAR PAR√ÅMETROS DESDE CONFIG.JSON
        // ============================================

        async function cargarParametrosCapacidad() {
            try {
                const response = await fetch('/api/capacidad-config');
                if (response.ok) {
                    parametrosCapacidad = await response.json();

                    // Actualizar marcadores visuales
                    const markerConservador = document.getElementById('marker-conservador');
                    const markerMaximo = document.getElementById('marker-maximo');
                    const markerAbsoluto = document.getElementById('marker-absoluto');

                    if (markerConservador) markerConservador.textContent = parametrosCapacidad.limite_conservador + '%';
                    if (markerMaximo) markerMaximo.textContent = parametrosCapacidad.limite_maximo + '%';
                    if (markerAbsoluto) markerAbsoluto.textContent = parametrosCapacidad.limite_absoluto + '%';

                    // Actualizar posici√≥n de marcadores
                    const marcadores = document.querySelectorAll('.debt-meter-marker');
                    if (marcadores[0]) marcadores[0].style.left = parametrosCapacidad.limite_conservador + '%';
                    if (marcadores[1]) marcadores[1].style.left = parametrosCapacidad.limite_maximo + '%';
                    if (marcadores[2]) marcadores[2].style.left = parametrosCapacidad.limite_absoluto + '%';

                    // Actualizar leyenda
                    const legendConservador = document.getElementById('legend-conservador');
                    const legendModerado = document.getElementById('legend-moderado');
                    const legendAlto = document.getElementById('legend-alto');

                    // Actualizar leyenda con rangos SIN solapamiento
                    if (legendConservador) {
                        legendConservador.textContent = "Bueno (26-" + parametrosCapacidad.limite_conservador + "%)";
                    }
                    if (legendModerado) {
                        var iniMod = parametrosCapacidad.limite_conservador + 1;
                        legendModerado.textContent = "Moderado (" + iniMod + "-" + parametrosCapacidad.limite_maximo + "%)";
                    }
                    if (legendAlto) {
                        var iniAlto = parametrosCapacidad.limite_maximo + 1;
                        legendAlto.textContent = "Alto (" + iniAlto + "-" + parametrosCapacidad.limite_absoluto + "%)";
                    }

                    console.log('‚úÖ Par√°metros de capacidad cargados:', parametrosCapacidad);
                } else {
                    console.warn('‚ö†Ô∏è No se pudieron cargar par√°metros, usando valores por defecto');
                }
            } catch (error) {
                console.error('‚ùå Error al cargar par√°metros:', error);
            }
        }

        // ============================================
        //    ACTUALIZAR BARRA GR√ÅFICA
        // ============================================

        function actualizarBarraGrafica(porcentajeActual) {
            const indicator = document.getElementById('debt-meter-indicator');
            const valueLabel = document.getElementById('debt-meter-value');

            if (!indicator || !valueLabel) return;

            // Limitar porcentaje entre 0 y 100 para visualizaci√≥n
            const porcentajeVisual = Math.min(Math.max(porcentajeActual, 0), 100);

            // Actualizar posici√≥n del indicador
            indicator.style.left = porcentajeVisual + '%';

            // Actualizar valor mostrado
            valueLabel.textContent = porcentajeActual.toFixed(1) + '%';

            // Cambiar color del indicador seg√∫n nivel
            let color;
            if (porcentajeActual <= 25) {
                color = '#28a745'; // Verde - Excelente
            } else if (porcentajeActual <= parametrosCapacidad.limite_conservador) {
                color = '#17a2b8'; // Azul - Bueno
            } else if (porcentajeActual <= parametrosCapacidad.limite_maximo) {
                color = '#FAFA8F'; // Amarillo claro - Moderado
            } else if (porcentajeActual < parametrosCapacidad.limite_absoluto) {
                color = '#fd7e14'; // Naranja - Alto Riesgo
            } else {
                color = '#dc3545'; // Rojo - Cr√≠tico
            }

            indicator.style.borderTopColor = color;
            valueLabel.style.background = color;
        }

        // ============================================
        // MEJORA: INTEGRACI√ìN CON SCORING
        // ============================================

        function continuarConScoring() {
            const btnContinuar = document.getElementById('btn-continuar-scoring');

            // Mostrar estado de carga
            const textoOriginal = btnContinuar.innerHTML;
            btnContinuar.disabled = true;
            btnContinuar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparando datos...';

            // Detectar metodolog√≠a activa
            const usaDatacredito = document.getElementById('usar_datacredito').checked;

            // Obtener ingreso base (siempre se exporta)
            const ingresoMensual = parseFloat(document.getElementById('ingreso_mensual').value.replace(/\./g, '').replace(/,/g, '.')) || 0;

            // Construir URL seg√∫n metodolog√≠a
            let url = '/scoring?source=capacidad_pago';
            let mensaje = '';
            let datosExportados = 1; // Contador de datos exportados

            if (usaDatacredito) {
                // ========================================
                // METODOLOG√çA H√çBRIDA (DataCr√©dito activo)
                // Exportar 3 datos
                // ========================================

                const ingresoDatacredito = parseFloat(document.getElementById('ingreso_datacredito').value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                const utilizacionIngreso = parseFloat(document.getElementById('utilizacion_ingreso').value) || 0;

                // Validar que los campos est√©n completos
                if (ingresoDatacredito === 0 || utilizacionIngreso === 0) {
                    alert('Por favor complete todos los campos de DataCr√©dito antes de continuar.');
                    btnContinuar.disabled = false;
                    btnContinuar.innerHTML = textoOriginal;
                    return;
                }

                // Construir URL con 3 par√°metros
                url += `&criterio_1753279804789=${ingresoMensual}`;
                url += `&ingresos_netos=${ingresoDatacredito}`;
                url += `&relacion_deuda=${utilizacionIngreso}`;

                mensaje = `Datos importados desde Capacidad de Pago (DataCr√©dito): Ingreso Real ($${formatearMoneda(ingresoMensual)}), Ingreso Estimado ($${formatearMoneda(ingresoDatacredito)}), Utilizaci√≥n (${utilizacionIngreso}%)`;
                datosExportados = 3;

            } else {
                // ========================================
                // METODOLOG√çA NORMAL (sin DataCr√©dito)
                // Exportar 1 dato
                // ========================================

                // Construir URL con 1 par√°metro
                url += `&criterio_1753279804789=${ingresoMensual}`;

                mensaje = `Datos importados desde Capacidad de Pago: Ingreso verificable ($${formatearMoneda(ingresoMensual)})`;
                datosExportados = 1;
            }

            // Agregar mensaje como par√°metro
            url += `&mensaje=${encodeURIComponent(mensaje)}`;
            url += `&datos_importados=${datosExportados}`;

            // ========================================
            // ABRIR EN NUEVA PESTA√ëA
            // ========================================
            window.open(url, '_blank');

            // Restaurar bot√≥n despu√©s de un momento
            setTimeout(() => {
                btnContinuar.disabled = false;
                btnContinuar.innerHTML = textoOriginal;
            }, 1000);
        }

        // Funci√≥n auxiliar para formatear moneda
        function formatearMoneda(valor) {
            return valor.toLocaleString('es-CO');
        }

        function formatNumber(input) {
            let value = input.value.replace(/\./g, '');
            value = value.replace(/\D/g, '');
            value = value.replace(/^0+/, '');
            if (value) {
                input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            } else {
                input.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // MEJORA: Cargar par√°metros al iniciar
            cargarParametrosCapacidad();

            document.getElementById('btnCalcularCapacidad').addEventListener('click', function(event) {
                event.preventDefault();
                calcularCapacidad();
            });

            document.getElementById('usar_datacredito').addEventListener('change', function() {
                toggleModoCalculo();
            });

            document.getElementById('ingreso_datacredito').addEventListener('input', function() {
                actualizarObligacionesEstimadas();
            });

            document.getElementById('utilizacion_ingreso').addEventListener('input', function() {
                actualizarObligacionesEstimadas();
            });

            toggleModoCalculo();

            const consoleMessages = [
                'ADVERTENCIA: Esta es una funci√≥n de desarrollador. Si alguien te pidi√≥ que copies/pegues algo aqu√≠ para habilitar una funci√≥n o "hackear" una cuenta, es un intento de fraude.',
                'SEGURIDAD: No deber√≠as estar aqu√≠ a menos que sepas lo que est√°s haciendo.',
            ];

            console.log('%c¬°DETENTE!', 'color: red; font-size: 30px; font-weight: bold;');
            console.log('%c' + consoleMessages[0], 'color: red; font-size: 14px;');
            console.log('%c' + consoleMessages[1], 'color: red; font-size: 14px;');

            document.addEventListener('contextmenu', function(e) {
                // Permitir click derecho en enlaces (para abrir en nueva pesta√±a)
                if (e.target.tagName === 'A' || e.target.closest('a')) {
                    return true; // Permitir men√∫ contextual en enlaces
                }

                // Bloquear click derecho en el resto del contenido (seguridad)
                e.preventDefault();
                return false;
            });
        });

        function toggleModoCalculo() {
            const modoAutomatico = document.getElementById('usar_datacredito').checked;
            document.getElementById('seccion_obligaciones_manuales').style.display = modoAutomatico ? 'none' : 'block';
            document.getElementById('seccion_datacredito').style.display = modoAutomatico ? 'block' : 'none';
            document.getElementById('explicacion_metodologia').style.display = modoAutomatico ? 'block' : 'none';
            if (modoAutomatico) {
                actualizarObligacionesEstimadas();
            }
        }

        function actualizarObligacionesEstimadas() {
            const ingresoDatacredito = parseFloat(document.getElementById('ingreso_datacredito').value.replace(/\./g, '')) || 0;
            const utilizacionIngreso = parseFloat(document.getElementById('utilizacion_ingreso').value) || 0;
            const obligacionesEstimadas = ingresoDatacredito * (utilizacionIngreso / 100);
            document.getElementById('obligaciones_estimadas').textContent = Math.round(obligacionesEstimadas).toLocaleString('es-CO');
        }

        function calcularCapacidad() {
            try {
                // Verificar sesi√≥n antes de calcular
                const csrfToken = document.querySelector('input[name="csrf_token"]');
                if (!csrfToken || !csrfToken.value) {
                    alert('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
                    window.location.href = '/login';
                    return false;
                }

                const ingresoReal = parseFloat(document.getElementById('ingreso_mensual').value.replace(/\./g, '')) || 0;
                const plazo = parseInt(document.getElementById('plazo').value) || 12;
                const tasaAnual = parseFloat(document.getElementById('tasa_anual').value.replace(',', '.')) || 25.12;
                const modoAutomatico = document.getElementById('usar_datacredito').checked;

                let obligacionesActuales = 0;
                let fuenteObligaciones = "Manual";

                if (modoAutomatico) {
                    const ingresoDatacredito = parseFloat(document.getElementById('ingreso_datacredito').value.replace(/\./g, '')) || 0;
                    const utilizacionIngreso = parseFloat(document.getElementById('utilizacion_ingreso').value) || 0;
                    obligacionesActuales = ingresoDatacredito * (utilizacionIngreso / 100);
                    fuenteObligaciones = "DataCr√©dito (completas)";
                } else {
                    obligacionesActuales = parseFloat(document.getElementById('obligaciones_actuales').value.replace(/\./g, '')) || 0;
                    fuenteObligaciones = "Reportadas por cliente";
                }

                const ingresoBase = ingresoReal;

                if (ingresoBase <= 0) {
                    alert('El ingreso mensual real debe ser mayor que cero.');
                    return false;
                }

                const porcentajeActual = (obligacionesActuales / ingresoBase) * 100;
                const ingresoDisponible = Math.max(0, ingresoBase - obligacionesActuales);

                // L√≠mites m√°ximos seg√∫n pol√≠tica (X% y Y% del ingreso TOTAL)
                const limiteAbsoluto = ingresoBase * (parametrosCapacidad.limite_absoluto / 100);
                const limiteMaximo = ingresoBase * (parametrosCapacidad.limite_maximo / 100);
                const limiteConservador = ingresoBase * (parametrosCapacidad.limite_conservador / 100);

                // Para mantener compatibilidad con c√≥digo existente
                const limiteMaximo40 = limiteAbsoluto;
                const limiteRecomendado35 = limiteMaximo;

                // Capacidad disponible = L√≠mite - Obligaciones actuales
                const capacidadDisponible40 = Math.max(0, limiteMaximo40 - obligacionesActuales);
                const capacidadDisponible35 = Math.max(0, limiteRecomendado35 - obligacionesActuales);

                // Para el display (mantener compatibilidad)
                const capacidadMaxima40 = limiteMaximo40;
                const capacidadMaxima35 = limiteRecomendado35;

                const tasaMensual = Math.pow(1 + (tasaAnual / 100), 1/12) - 1;

                // VALIDACI√ìN: Evitar divisi√≥n por cero
                let factor;
                if (tasaMensual <= 0 || plazo <= 0) {
                    factor = plazo;  // Fallback: usar plazo directamente
                    alert('Advertencia: Tasa de inter√©s muy baja, usando c√°lculo simplificado');
                } else {
                    factor = (tasaMensual * Math.pow(1 + tasaMensual, plazo)) /
                             (Math.pow(1 + tasaMensual, plazo) - 1);
                }

                const montoMaximo = capacidadDisponible40 / factor;
                const montoRecomendado = capacidadDisponible35 / factor;

                // Determinar nivel con l√≠mites din√°micos
                let nivelEndeudamiento, claseNivel, recomendacionTexto;

                // Obtener l√≠mites de config (con fallback a valores por defecto)
                var limConservador = 30;
                var limMaximo = 35;
                var limAbsoluto = 40;

                if (typeof parametrosCapacidad !== 'undefined') {
                    limConservador = parametrosCapacidad.limite_conservador || 30;
                    limMaximo = parametrosCapacidad.limite_maximo || 35;
                    limAbsoluto = parametrosCapacidad.limite_absoluto || 40;
                }

                if (porcentajeActual <= 25) {
                    nivelEndeudamiento = "Excelente";
                    claseNivel = "bg-success";
                    recomendacionTexto = "Cliente excelente con amplio margen financiero. Aprobaci√≥n hasta monto m√°ximo recomendada.";
                } else if (porcentajeActual <= limConservador) {
                    nivelEndeudamiento = "Bueno";
                    claseNivel = "bg-info text-white";
                    recomendacionTexto = "Nivel de endeudamiento saludable (hasta " + limConservador + "%). Aprobaci√≥n con condiciones est√°ndar recomendada.";
                } else if (porcentajeActual <= limMaximo) {
                    nivelEndeudamiento = "Moderado";
                    claseNivel = "badge-moderado";
                    recomendacionTexto = "Endeudamiento entre " + limConservador + "% y " + limMaximo + "%. Evaluar scoring crediticio antes de aprobar.";
                } else if (porcentajeActual < limAbsoluto) {
                    nivelEndeudamiento = "Alto Riesgo";
                    claseNivel = "badge-alto-riesgo";
                    recomendacionTexto = "Endeudamiento entre " + limMaximo + "% y menos de " + limAbsoluto + "%. Solo casos excepcionales con garant√≠as adicionales.";
                } else {
                    nivelEndeudamiento = "Cr√≠tico";
                    claseNivel = "bg-danger";
                    recomendacionTexto = "Endeudamiento de " + limAbsoluto + "% o superior. NO se recomienda aprobar. Riesgo muy alto de impago.";
                }

                function formatearNumero(num) {
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                }

                document.getElementById('porcentaje-actual').textContent = porcentajeActual.toFixed(1);
                document.getElementById('nivel-endeudamiento').textContent = nivelEndeudamiento;
                document.getElementById('nivel-endeudamiento').className = 'badge badge-level ' + claseNivel;
                document.getElementById('obligaciones-calculadas').textContent = formatearNumero(Math.round(obligacionesActuales));
                document.getElementById('capacidad-maxima').textContent = formatearNumero(Math.round(capacidadMaxima40));
                document.getElementById('capacidad-disponible').textContent = formatearNumero(Math.round(capacidadDisponible40));
                document.getElementById('cuota-maxima').textContent = formatearNumero(Math.round(capacidadDisponible40));
                document.getElementById('monto-maximo').textContent = formatearNumero(Math.round(montoMaximo));
                document.getElementById('monto-recomendado').textContent = formatearNumero(Math.round(montoRecomendado));
                document.getElementById('recomendacion-texto').textContent = recomendacionTexto;

                document.getElementById('metodologia-aplicada').style.display = 'block';
                document.getElementById('ingreso-base-usado').textContent = formatearNumero(Math.round(ingresoBase));
                document.getElementById('obligaciones-fuente').textContent = formatearNumero(Math.round(obligacionesActuales));
                document.getElementById('fuente-obligaciones').textContent = fuenteObligaciones;

                // Mostrar/ocultar mensaje de metodolog√≠a h√≠brida seg√∫n estado del switch
                const mensajeMetodologia = document.querySelector('#metodologia-aplicada .text-muted');
                if (mensajeMetodologia) {
                    if (modoAutomatico) {
                        mensajeMetodologia.style.display = 'block';
                    } else {
                        mensajeMetodologia.style.display = 'none';
                    }
                }
                //  Actualizar barra gr√°fica
                actualizarBarraGrafica(porcentajeActual);

                //  Guardar datos para integraci√≥n con scoring
                datosCapacidadActuales = {
                    nombre_cliente: document.getElementById('nombre_cliente') ? document.getElementById('nombre_cliente').value : '',
                    ingreso_mensual: ingresoReal,
                    obligaciones_actuales: obligacionesActuales,
                    plazo: plazo,
                    tasa_anual: tasaAnual,
                    porcentaje_endeudamiento: porcentajeActual,
                    capacidad_maxima: capacidadMaxima40,
                    monto_maximo: montoMaximo,
                    monto_recomendado: montoRecomendado,
                    fecha_calculo: new Date().toISOString()
                };

                document.getElementById('resultado-capacidad').style.display = 'block';
                document.getElementById('resultado-capacidad').scrollIntoView({ behavior: 'smooth' });

                return false;
            } catch (error) {
                console.error("Error al calcular capacidad:", error);
                alert("Ocurri√≥ un error al calcular la capacidad de pago: " + error.message);
                return false;
            }
        }
        // ============================================
        // DETECTAR SESI√ìN EXPIRADA
        // ============================================

        // Interceptar todos los fetch para detectar sesi√≥n expirada
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args)
                .then(response => {
                    // Si es 401 (no autorizado) o 403 (prohibido), redirigir a login
                    if (response.status === 401 || response.status === 403) {
                        console.warn('‚ö†Ô∏è Sesi√≥n expirada detectada');
                        alert('Tu sesi√≥n ha expirado. Ser√°s redirigido al login.');
                        window.location.href = '/login';
                        return Promise.reject(new Error('Sesi√≥n expirada'));
                    }
                    return response;
                })
                .catch(error => {
                    console.error('Error en fetch:', error);
                    throw error;
                });
        };

        // Detectar error de cach√© (ERR_CACHE_MISS)
        window.addEventListener('pageshow', function(event) {
            // Si la p√°gina viene del cach√© del navegador (back/forward)
            if (event.persisted) {
                console.log('üìÑ P√°gina cargada desde cach√©');
                // Verificar si la sesi√≥n sigue activa
                fetch('/api/capacidad-config', {
                    method: 'GET',
                    cache: 'no-cache'
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Sesi√≥n no v√°lida, recargando...');
                    window.location.reload();
                });
            }
        });

        // Prevenir env√≠o de formularios si la sesi√≥n expir√≥
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    // Verificar si hay token CSRF v√°lido
                    const csrfToken = document.querySelector('input[name="csrf_token"]');
                    if (!csrfToken || !csrfToken.value) {
                        e.preventDefault();
                        alert('Tu sesi√≥n ha expirado. Ser√°s redirigido al login.');
                        window.location.href = '/login';
                        return false;
                    }
                });
            }
        });
    </script>
</head>
<body>
    <!-- Navegaci√≥n unificada desde partial -->
    {% include 'partials/navbar_asesor.html' %}

    <div class="container">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-calculator"></i> Calcular Capacidad de Endeudamiento
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Complete este formulario para evaluar la capacidad de pago del cliente y determinar el monto m√°ximo recomendado de cr√©dito.
                </div>

                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="usar_datacredito">
                    <label class="form-check-label" for="usar_datacredito">Usar DataCr√©dito</label>
                    <small class="text-muted d-block mt-1">Active para calcular obligaciones a partir de datos de DataCr√©dito.</small>
                </div>

                <div id="explicacion_metodologia" style="display:none;" class="metodologia-detail">
                    <span class="metodologia-badge">
                        <i class="bi bi-shield-check me-1"></i>Metodolog√≠a H√≠brida-Conservadora
                    </span>
                    <h6 class="fw-bold mb-2">¬øPor qu√© esta metodolog√≠a es la m√°s segura para fintechs?</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="fuente-indicator">
                                <strong><i class="bi bi-receipt me-1"></i>Ingreso Base:</strong><br>
                                <small>Ingreso real comprobable (desprendibles/certificaci√≥n)</small>
                                <div class="text-success fw-bold">‚úì Conservador y verificable</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="fuente-indicator">
                                <strong><i class="bi bi-database me-1"></i>Obligaciones:</strong><br>
                                <small>Estimadas desde DataCr√©dito (m√°s completas)</small>
                                <div class="text-info fw-bold">‚úì Incluye deudas ocultas</div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-success mt-2 mb-0">
                        <small><strong>Resultado:</strong> An√°lisis que protege tanto al cliente (no sobreendeudamiento) como a la instituci√≥n (menor riesgo de cartera vencida)</small>
                    </div>
                </div>

                <form id="form-capacidad">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ingreso_mensual" class="form-label">Ingreso Mensual Real Neto</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="ingreso_mensual"
                                           placeholder="Ej: 2.500.000" oninput="formatNumber(this)" required>
                                </div>
                                <div class="form-text">Ingreso neto mensual comprobable del cliente (certificado, extractos).</div>
                            </div>

                            <div id="seccion_obligaciones_manuales">
                                <div class="mb-3">
                                    <label for="obligaciones_actuales" class="form-label">Obligaciones Mensuales Actuales</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="obligaciones_actuales"
                                               placeholder="Ej: 800.000" oninput="formatNumber(this)">
                                    </div>
                                    <div class="form-text">Suma de todas las cuotas crediticias actuales del cliente.</div>
                                </div>
                            </div>

                            <div id="seccion_datacredito" style="display:none;">
                                <div class="mb-3">
                                    <label for="ingreso_datacredito" class="form-label">Ingreso Estimado DataCr√©dito</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="ingreso_datacredito"
                                               placeholder="Ej: 2.000.000" oninput="formatNumber(this); actualizarObligacionesEstimadas();">
                                    </div>
                                    <div class="form-text">Ingreso estimado que aparece en el reporte DataCr√©dito.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="utilizacion_ingreso" class="form-label">Utilizaci√≥n del Ingreso (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="utilizacion_ingreso"
                                               placeholder="Ej: 50" min="0" max="100" oninput="actualizarObligacionesEstimadas();">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="form-text">% Utilizaci√≥n del ingreso estimado (aparece en DataCr√©dito).</div>
                                </div>

                                <div class="mb-3 alert alert-secondary">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>Obligaciones estimadas:</div>
                                        <div class="fw-bold">$<span id="obligaciones_estimadas">0</span></div>
                                    </div>
                                    <small class="text-muted">C√°lculo: Ingreso DataCr√©dito √ó % Utilizaci√≥n</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="plazo" class="form-label">Plazo del cr√©dito (meses)</label>
                                <input type="number" class="form-control" id="plazo"
                                       placeholder="Ej: 24" min="1" max="60" value="12" required>
                                <div class="form-text">Plazo del cr√©dito que se va a evaluar.</div>
                            </div>

                            <div class="mb-3">
                                <label for="tasa_anual" class="form-label">Tasa Efectiva Anual (%)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="tasa_anual"
                                           placeholder="Ej: 25.12" value="25.12" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Tasa efectiva anual del cr√©dito.</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="btnCalcularCapacidad" type="button" class="btn btn-primary">
                            <i class="bi bi-calculator"></i> Calcular Capacidad de Pago
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resultados  -->
        <div id="resultado-capacidad" style="display:none;" class="mt-4">
            <div class="alert alert-primary mb-3" id="metodologia-aplicada" style="display:none;">
                <h6><i class="bi bi-shield-check me-2"></i>Metodolog√≠a Aplicada en este An√°lisis</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="metodologia-info-box">
                            <div class="metodologia-label">Ingreso base (capacidades):</div>
                            <div class="metodologia-value">$<span id="ingreso-base-usado">0</span></div>
                            <div class="metodologia-source">Real comprobable</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metodologia-info-box">
                            <div class="metodologia-label">Obligaciones:</div>
                            <div class="metodologia-value">$<span id="obligaciones-fuente">0</span></div>
                            <div class="metodologia-source"><span id="fuente-obligaciones">Manual</span></div>
                        </div>
                    </div>
                </div>
                <small class="text-muted">Esta metodolog√≠a h√≠brida asegura un an√°lisis conservador basado en ingresos reales con obligaciones completas.</small>
            </div>

            <div class="result-box">
                <div class="result-header">
                    <h5 class="mb-0">Resultado del An√°lisis</h5>
                </div>
                <!-- BARRA GR√ÅFICA DE ENDEUDAMIENTO -->
                <div class="debt-meter-container">
                    <div class="debt-meter-title">
                        <i class="bi bi-speedometer2 me-2"></i>Nivel de Endeudamiento
                    </div>

                    <!-- Barra de colores (sin elementos internos) -->
                    <div class="debt-meter-bar" id="debt-meter-bar"></div>

                    <!-- Indicador de posici√≥n actual ABAJO de la barra -->
                    <div class="debt-meter-indicator-wrapper">
                        <div class="debt-meter-indicator" id="debt-meter-indicator" style="left: 0%;">
                            <div class="debt-meter-indicator-arrow"></div>
                            <span class="debt-meter-value" id="debt-meter-value">0%</span>
                        </div>
                    </div>

                    <!-- Leyenda de colores - COLORES UNIFICADOS -->
                    <div class="debt-meter-legend">
                        <div class="debt-meter-legend-item">
                            <div class="debt-meter-legend-color" style="background: #28a745;"></div>
                            <span>Excelente (0-25%)</span>
                        </div>
                        <div class="debt-meter-legend-item">
                            <div class="debt-meter-legend-color" style="background: #17a2b8;"></div>
                            <span id="legend-conservador">Bueno (26-30%)</span>
                        </div>
                        <div class="debt-meter-legend-item">
                            <div class="debt-meter-legend-color" style="background: #FAFA8F;"></div>
                            <span id="legend-moderado">Moderado (31-35%)</span>
                        </div>
                        <div class="debt-meter-legend-item">
                            <div class="debt-meter-legend-color" style="background: #fd7e14;"></div>
                            <span id="legend-alto">Alto (36-39%)</span>
                        </div>
                        <div class="debt-meter-legend-item">
                            <div class="debt-meter-legend-color" style="background: #dc3545;"></div>
                            <span>Cr√≠tico (‚â•40%)</span>
                        </div>
                    </div>

                <div class="row mb-3">
                    <div class="col-md-4 d-flex flex-column align-items-center justify-content-center" style="gap: 8px;">
                        <h6 class="mb-1 text-muted" style="font-size: 14px; font-weight: 500;">Endeudamiento Actual</h6>
                        <div class="percentage-display mb-1">
                            <span id="porcentaje-actual">0</span>%
                        </div>
                        <span class="badge badge-level bg-success" id="nivel-endeudamiento">Ideal</span>
                    </div>

                    <div class="col-md-8">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td>Obligaciones calculadas:</td>
                                        <td class="text-end fw-bold">$<span id="obligaciones-calculadas">0</span></td>
                                    </tr>
                                    <tr>
                                        <td>Capacidad m√°xima (40%):</td>
                                        <td class="text-end fw-bold">$<span id="capacidad-maxima">0</span></td>
                                    </tr>
                                    <tr>
                                        <td>Capacidad disponible:</td>
                                        <td class="text-end fw-bold">$<span id="capacidad-disponible">0</span></td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td>Cuota m√°xima mensual:</td>
                                        <td class="text-end fw-bold">$<span id="cuota-maxima">0</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <h5 class="text-center mb-3">Monto M√°ximo a Prestar</h5>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="amount-box max-amount">
                            <h5>Monto M√°ximo (40%)</h5>
                            <div class="amount">$<span id="monto-maximo">0</span></div>
                            <small>L√≠mite absoluto seg√∫n pol√≠tica</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="amount-box recommended-amount">
                            <h5>Monto Recomendado (35%)</h5>
                            <div class="amount">$<span id="monto-recomendado">0</span></div>
                            <small>Recomendaci√≥n conservadora</small>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mb-4">
                    <h6><i class="bi bi-exclamation-triangle-fill me-2"></i>Interpretaci√≥n de Resultados:</h6>
                    <p class="mb-2"><strong>Monto M√°ximo (40%):</strong> Es el l√≠mite absoluto seg√∫n pol√≠tica de endeudamiento del ingreso real.</p>
                    <p class="mb-2"><strong>Monto Recomendado (35%):</strong> Es la recomendaci√≥n conservadora. Si aparece en $0, significa que el cliente ya tiene obligaciones que superan el 35% del ingreso real.</p>
                    <p class="mb-2"><strong>‚ö†Ô∏è Importante cuando se usa DataCr√©dito:</strong> Si el cliente ya tiene obligaciones altas (calculadas desde el % de utilizaci√≥n de DataCr√©dito), puede que el monto recomendado sea $0 aunque haya capacidad en el m√°ximo. Esto indica sobreendeudamiento relativo.</p>
                    <p class="mb-0"><strong>Recomendaci√≥n:</strong> Si Monto Recomendado = $0 pero Monto M√°ximo > $0, evaluar con scoring y garant√≠as adicionales.</p>
                </div>

                <div class="card bg-light border-primary mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-bank me-2"></i>Recomendaci√≥n para Fintech:</h6>
                        <p class="mb-2">Como sugieren los bancos y fintechs, considere:</p>
                        <ul class="mb-0">
                            <li>Para cr√©ditos peque√±os (&lt;5MM): Preferir el monto recomendado (35%)</li>
                            <li>Para cr√©ditos grandes (&gt;5MM): Considerar montos de hasta el 90% del m√°ximo</li>
                            <li>Cuando la diferencia entre m√°ximo y recomendado es grande: Realizar validaci√≥n adicional de ingresos</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h6 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i>Recomendaci√≥n para el asesor:</h6>
                    <p id="recomendacion-texto">Complete el formulario para recibir una evaluaci√≥n.</p>
                </div>
            </div>
            <!-- INTEGRACI√ìN CON SCORING -->
            <div class="alert alert-primary border-primary mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-2">
                                <i class="bi bi-graph-up-arrow me-2"></i>¬øQuieres evaluar tambi√©n el Scoring del cliente?
                            </h6>
                            <p class="mb-0 small">
                                Complementa este an√°lisis de capacidad de pago con una evaluaci√≥n de scoring crediticio.
                                Trasladaremos autom√°ticamente los datos ya ingresados.
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" id="btn-continuar-scoring" class="btn btn-scoring-integration" onclick="continuarConScoring()">
                                <i class="bi bi-arrow-right-circle"></i>Continuar con Scoring
                            </button>
                        </div>
                    </div>
                </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Tabla de Referencia para Fintech Colombiana</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Nivel de Endeudamiento</th>
                                <th>Rango</th>
                                <th>Interpretaci√≥n Fintech</th>
                                <th>Acci√≥n Recomendada</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge bg-success">Excelente</span></td>
                                <td><strong>0% - 25%</strong></td>
                                <td>Cliente ideal con amplio margen de maniobra financiera.</td>
                                <td>Aprobaci√≥n hasta monto m√°ximo</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-info text-white">Bueno</span></td>
                                <td><strong>26% - 30%</strong></td>
                                <td>Nivel saludable, cumple est√°ndares conservadores.</td>
                                <td>Aprobaci√≥n hasta monto recomendado</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning text-dark">Moderado</span></td>
                                <td><strong>31% - 35%</strong></td>
                                <td>Requiere evaluaci√≥n adicional, a√∫n dentro de l√≠mites aceptables.</td>
                                <td>Aprobaci√≥n condicionada con an√°lisis de scoring</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-alto-riesgo">Alto Riesgo</span></td>
                                <td><strong>36% - 39%</strong></td>
                                <td>Solo para clientes con excelente scoring y garant√≠as adicionales.</td>
                                <td>Evaluaci√≥n case-by-case con gerencia</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-danger">Cr√≠tico</span></td>
                                <td><strong>‚â• 40%</strong></td>
                                <td>Sobreendeudamiento que compromete capacidad de pago.</td>
                                <td>Rechazo autom√°tico</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/theme-unified.js"></script>
</body>
</html>