<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Historial de Simulaciones - Loansi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/components.css" rel="stylesheet">
    <style>
        /* Contenedor principal que aprovecha todo el ancho */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Tarjetas de estadísticas */
        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0.25rem;
        }

        /* Filtros */
        .filters-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        /* Tabla responsiva que aprovecha el espacio */
        .table-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
            width: 100%;
            table-layout: auto;
        }

        .table th {
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem;
            white-space: nowrap;
            background: var(--bg-secondary);
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
        }

        /* Columnas de la tabla con anchos optimizados */
        .col-fecha { width: 10%; min-width: 90px; }
        .col-cliente { width: 14%; min-width: 110px; }
        .col-cedula { width: 10%; min-width: 90px; }
        .col-monto { width: 11%; min-width: 95px; text-align: right; }
        .col-plazo { width: 7%; min-width: 55px; text-align: center; }
        .col-linea { width: 11%; min-width: 95px; }
        .col-cuota { width: 11%; min-width: 95px; text-align: right; }
        .col-tasa { width: 9%; min-width: 70px; text-align: center; }
        .col-acciones { width: 7%; min-width: 60px; text-align: center; }

        /* Badges para línea de crédito */
        .badge-linea {
            font-size: 0.75rem;
            padding: 0.4em 0.8em;
            border-radius: 6px;
            font-weight: 500;
        }

        .badge-loansiflex { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .badge-loansimoto { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .badge-microflex { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .badge-default { background: var(--bg-secondary); color: var(--text-primary); }

        /* Montos formateados */
        .monto-value {
            font-weight: 600;
            font-family: 'Inter', monospace;
        }

        /* Header de página */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .page-title i {
            color: var(--primary-color);
        }

        /* Scope badge */
        .scope-badge {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Estilos para el modal de detalle */
        .detail-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .detail-section h6 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .detail-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .detail-value.highlight {
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .table th, .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
            .col-cedula { display: none; }
        }

        @media (max-width: 992px) {
            .stat-card .stat-number {
                font-size: 2rem;
            }
            .col-tasa { display: none; }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            /* En móvil, mostrar como cards en lugar de tabla */
            .table-desktop { display: none; }
            .cards-mobile { display: block; }
        }

        @media (min-width: 769px) {
            .cards-mobile { display: none; }
            .table-desktop { display: block; }
        }

        /* Cards para móvil */
        .sim-card-mobile {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .sim-card-mobile .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .sim-card-mobile .sim-cliente {
            font-weight: 600;
            font-size: 1rem;
        }

        .sim-card-mobile .sim-fecha {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .sim-card-mobile .sim-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .sim-card-mobile .sim-detail {
            display: flex;
            flex-direction: column;
        }

        .sim-card-mobile .sim-detail-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .sim-card-mobile .sim-detail-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sim-card-mobile .sim-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        /* Info banner */
        .info-banner {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
{% include 'partials/navbar_asesor.html' %}

<div class="main-container">

    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="bi bi-clock-history"></i>
                Historial de Simulaciones
            </h1>
        </div>
        <div class="d-flex gap-2 align-items-center">
            {% if scope %}
            <span class="scope-badge">
                <i class="bi bi-person-badge me-1"></i>
                {% if scope == 'propio' %}Mis simulaciones{% elif scope == 'equipo' %}Mi equipo{% else %}Todas{% endif %}
            </span>
            {% endif %}
            <a href="/simulador" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Nueva Simulación
            </a>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number">{{ simulaciones|length }}</div>
                <div class="stat-label">Total Simulaciones</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number">{{ clientes|length }}</div>
                <div class="stat-label">Clientes Únicos</div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="stat-card">
                <div class="stat-number">{{ (simulaciones|length / clientes|length)|round(1) if clientes|length > 0 else 0 }}</div>
                <div class="stat-label">Promedio por Cliente</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
        <form class="row g-2 align-items-end" method="get" id="filtrosForm">
            <div class="col-md-3 col-6">
                <label class="form-label small fw-semibold mb-1">
                    <i class="bi bi-funnel me-1"></i>Filtrar por Rango de Fechas
                </label>
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small mb-1">Desde</label>
                <input type="date" class="form-control form-control-sm" name="desde"
                       value="{{ request.args.get('desde', '') }}" id="fechaDesde">
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small mb-1">Hasta</label>
                <input type="date" class="form-control form-control-sm" name="hasta"
                       value="{{ request.args.get('hasta', '') }}" id="fechaHasta">
            </div>
            <div class="col-md-3 col-6 d-flex gap-2">
                <button type="submit" class="btn btn-sm btn-primary flex-fill">
                    <i class="bi bi-funnel me-1"></i>Filtrar
                </button>
                <a href="{{ url_for('simulador.historial_simulaciones') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Indicador de filtro activo -->
    {% if request.args.get('desde') or request.args.get('hasta') %}
    <div class="info-banner">
        <i class="bi bi-info-circle text-primary"></i>
        <span>
            Mostrando simulaciones
            {% if request.args.get('desde') %}desde {{ request.args.get('desde') }}{% endif %}
            {% if request.args.get('hasta') %}hasta {{ request.args.get('hasta') }}{% endif %}
        </span>
    </div>
    {% endif %}

    <!-- Tabla Desktop -->
    <div class="table-container table-desktop">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th class="col-fecha">Fecha</th>
                    <th class="col-cliente">Cliente</th>
                    <th class="col-cedula">Cédula</th>
                    <th class="col-monto">Monto</th>
                    <th class="col-plazo">Plazo</th>
                    <th class="col-linea">Línea</th>
                    <th class="col-cuota">Cuota</th>
                    <th class="col-tasa">Tasa EA</th>
                    <th class="col-acciones">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for sim in simulaciones %}
                <tr>
                    <td class="col-fecha">
                        <small class="text-muted">{{ sim.timestamp[:10] }}</small><br>
                        <small>{{ sim.timestamp[11:16] }}</small>
                    </td>
                    <td class="col-cliente">
                        <span class="fw-semibold">{{ sim.cliente }}</span>
                    </td>
                    <td class="col-cedula">
                        <code class="small">{{ sim.cedula }}</code>
                    </td>
                    <td class="col-monto">
                        <span class="monto-value">${{ "{:,.0f}".format(sim.monto|int) }}</span>
                    </td>
                    <td class="col-plazo text-center">
                        <span class="badge bg-secondary">{{ sim.plazo }}</span>
                    </td>
                    <td class="col-linea">
                        {% set linea_lower = sim.linea_credito|lower|replace(' ', '') %}
                        <span class="badge badge-linea {% if 'loansiflex' in linea_lower %}badge-loansiflex{% elif 'moto' in linea_lower %}badge-loansimoto{% elif 'micro' in linea_lower %}badge-microflex{% else %}badge-default{% endif %}">
                            {{ sim.linea_credito }}
                        </span>
                    </td>
                    <td class="col-cuota">
                        <span class="monto-value">${{ "{:,.0f}".format(sim.cuota_mensual|int) }}</span>
                    </td>
                    <td class="col-tasa text-center">
                        <span class="fw-semibold">{{ sim.tasa_ea }}%</span>
                    </td>
                    <td class="col-acciones text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalleSimulacion('{{ sim.timestamp }}', '{{ sim.cliente|replace("'", "\\'") }}', '{{ sim.cedula }}', {{ sim.monto }}, {{ sim.plazo }}, '{{ sim.linea_credito }}', {{ sim.cuota_mensual }}, {{ sim.tasa_ea }}, {{ sim.tasa_mensual }}, '{{ sim.nivel_riesgo|default("N/A") }}', {{ sim.aval|default(0) }}, {{ sim.seguro|default(0) }}, '{{ sim.plataforma|default("N/A") }}', {{ sim.total_financiar|default(sim.monto) }}, '{{ sim.asesor|default("N/A") }}', '{{ sim.modalidad_desembolso|default("N/A") }}')" title="Ver detalle">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
                        <span class="text-muted">No hay simulaciones en este período</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Cards Móvil -->
    <div class="cards-mobile">
        {% for sim in simulaciones %}
        <div class="sim-card-mobile">
            <div class="sim-header">
                <div>
                    <div class="sim-cliente">{{ sim.cliente }}</div>
                    <div class="sim-fecha">{{ sim.timestamp[:16].replace('T', ' ') }}</div>
                </div>
                {% set linea_lower = sim.linea_credito|lower|replace(' ', '') %}
                <span class="badge badge-linea {% if 'loansiflex' in linea_lower %}badge-loansiflex{% elif 'moto' in linea_lower %}badge-loansimoto{% elif 'micro' in linea_lower %}badge-microflex{% else %}badge-default{% endif %}">
                    {{ sim.linea_credito }}
                </span>
            </div>
            <div class="sim-details">
                <div class="sim-detail">
                    <span class="sim-detail-label">Monto</span>
                    <span class="sim-detail-value">${{ "{:,.0f}".format(sim.monto|int) }}</span>
                </div>
                <div class="sim-detail">
                    <span class="sim-detail-label">Cuota</span>
                    <span class="sim-detail-value">${{ "{:,.0f}".format(sim.cuota_mensual|int) }}</span>
                </div>
                <div class="sim-detail">
                    <span class="sim-detail-label">Plazo</span>
                    <span class="sim-detail-value">{{ sim.plazo }} meses</span>
                </div>
                <div class="sim-detail">
                    <span class="sim-detail-label">Tasa EA</span>
                    <span class="sim-detail-value">{{ sim.tasa_ea }}%</span>
                </div>
            </div>
            <div class="sim-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="verDetalleSimulacion('{{ sim.timestamp }}', '{{ sim.cliente|replace("'", "\\'") }}', '{{ sim.cedula }}', {{ sim.monto }}, {{ sim.plazo }}, '{{ sim.linea_credito }}', {{ sim.cuota_mensual }}, {{ sim.tasa_ea }}, {{ sim.tasa_mensual }}, '{{ sim.nivel_riesgo|default("N/A") }}', {{ sim.aval|default(0) }}, {{ sim.seguro|default(0) }}, '{{ sim.plataforma|default("N/A") }}', {{ sim.total_financiar|default(sim.monto) }}, '{{ sim.asesor|default("N/A") }}', '{{ sim.modalidad_desembolso|default("N/A") }}')">
                    <i class="bi bi-eye me-1"></i>Ver Detalle
                </button>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
            <span class="text-muted">No hay simulaciones</span>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Modal Ver Detalle de Simulación -->
<div class="modal fade" id="modalDetalleSimulacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Detalle de Simulación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalleSimulacionBody">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/theme-unified.js"></script>

<script>
// Auto-set fecha hasta como hoy si se selecciona desde
document.getElementById('fechaDesde')?.addEventListener('change', function() {
    const hastaInput = document.getElementById('fechaHasta');
    if (!hastaInput.value && this.value) {
        hastaInput.value = new Date().toISOString().split('T')[0];
    }
});

function formatMoney(val) {
    if (!val && val !== 0) return 'N/A';
    return '$' + parseFloat(val).toLocaleString('es-CO', {maximumFractionDigits: 0});
}

function _esc(x) {
    return (x ?? '').toString().replace(/[&<>"']/g, (c) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
}

function verDetalleSimulacion(timestamp, cliente, cedula, monto, plazo, linea, cuota, tasaEa, tasaMensual, nivelRiesgo, aval, seguro, plataforma, totalFinanciar, asesor, modalidad) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleSimulacion'));
    const body = document.getElementById('modalDetalleSimulacionBody');

    // Determinar clase del badge de línea
    const lineaLower = linea.toLowerCase().replace(/\s/g, '');
    let badgeClass = 'badge-default';
    if (lineaLower.includes('loansiflex')) badgeClass = 'badge-loansiflex';
    else if (lineaLower.includes('moto')) badgeClass = 'badge-loansimoto';
    else if (lineaLower.includes('micro')) badgeClass = 'badge-microflex';

    body.innerHTML = `
        <div class="row g-3">
            <!-- Información del Cliente -->
            <div class="col-md-6">
                <div class="detail-section">
                    <h6><i class="bi bi-person"></i> Información del Cliente</h6>
                    <div class="detail-row">
                        <span class="detail-label">Nombre</span>
                        <span class="detail-value">${_esc(cliente)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cédula</span>
                        <span class="detail-value">${_esc(cedula)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Nivel de Riesgo</span>
                        <span class="detail-value">${_esc(nivelRiesgo)}</span>
                    </div>
                </div>
            </div>

            <!-- Información del Crédito -->
            <div class="col-md-6">
                <div class="detail-section">
                    <h6><i class="bi bi-credit-card"></i> Información del Crédito</h6>
                    <div class="detail-row">
                        <span class="detail-label">Línea de Crédito</span>
                        <span class="badge badge-linea ${badgeClass}">${_esc(linea)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plataforma</span>
                        <span class="detail-value">${_esc(plataforma)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Modalidad</span>
                        <span class="detail-value">${_esc(modalidad)}</span>
                    </div>
                </div>
            </div>

            <!-- Detalles Financieros -->
            <div class="col-12">
                <div class="detail-section">
                    <h6><i class="bi bi-cash-stack"></i> Detalles Financieros</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Monto Solicitado</span>
                                <span class="detail-value highlight">${formatMoney(monto)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Plazo</span>
                                <span class="detail-value">${plazo} meses</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Tasa EA</span>
                                <span class="detail-value">${tasaEa}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Tasa Mensual</span>
                                <span class="detail-value">${tasaMensual}%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Cuota Mensual</span>
                                <span class="detail-value highlight">${formatMoney(cuota)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Aval</span>
                                <span class="detail-value">${formatMoney(aval)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Seguro</span>
                                <span class="detail-value">${formatMoney(seguro)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total a Financiar</span>
                                <span class="detail-value highlight">${formatMoney(totalFinanciar)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de la Simulación -->
            <div class="col-12">
                <div class="detail-section">
                    <h6><i class="bi bi-info-circle"></i> Información de la Simulación</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Asesor</span>
                                <span class="detail-value">${_esc(asesor)}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Fecha/Hora</span>
                                <span class="detail-value">${_esc(timestamp.replace('T', ' ').substring(0, 19))}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    modal.show();
}
</script>

</body>
</html>
